# generator-data-for-business-day-at-a-gas-station
Implementation of a data generator for gas stations
Генерация производится в два этапа:

Генерация нормативно - справочной информации
Генерация фактических данных по наливам и сливам
I Генерация нормативно - справочной информации

Задается детерминированный набор ПНПО по количеству и наименованиям соответствующий реальным ПНПО (https://www.rosneft-opt.ru/Krupnim_kontragentam). Для каждого ПНПО указывается: -
a. Краткое название (например, "ООО «РН-Волгоград»");
b. Уникальный целочисленный идентификатор ПНПО – ID ПНПО
С каждым ПНПО связывается соответствующее реальному число заправок. Для каждой заправки указывается:
a. Наименование в формате – <'АЗС'><ID ПНПО><уникальный ID АЗС> (АЗС_15_2);
b. ID ПНПО, к которому относится АЗС.
c. Уникальный целочисленный идентификатор АЗС - ID АЗС
С каждой АЗС связываются резервуары. Количество резервуаров на конкретной АЗС 4 или 5. Количество резервуаров на АЗС (4 или 5) генерируется случайным образом.
Для каждого резервуара задаются следующие параметры
a. Уникальный целочисленный ID резервуара
b. Объем резервуара.
Объем резервуара может быть: 10 куб.м., 25 куб.м. или 50 куб.м. Все резервуары на одной АЗС должны быть одного объема. Объем резервуаров для конкретной АЗС выбирается произвольно, но расчета того, чтобы
• количество АЗС с объемом резервуаров 10 куб. м. составляло 30% от общего кол-ва АЗС;
• количество АЗС с объемом резервуаров 25 куб. м. составляло 60% от общего кол-ва АЗС;
• количество АЗС с объемом резервуаров 50 куб. м. составляло 10% от общего кол-ва АЗС;
c. Минимальный остаток в резервуаре – 10% от объема в резервуаре.
d. Наименование вида заливаемого в резервуар топлива.
Если на АЗС 4-е резервуара, то им назначаются следующие виды топлива - АИ92, АИ95, ДТ, 95 Pulsar.
Если на АЗС 5-ть резервуаров, то им назначаются следующие виды топлива - АИ92, АИ95, ДТ, 95 Pulsar, 100 Pulsar.
e. Наименование резервуара в формате – <'Резервуар'><ID ПНПО><ID АЗС>_<ID резервуара>. Например, 'Резервуар_15_2_2';
f. ID ПНПО, к которому относится резервуар;
g. ID АЗС, к которой относится резервуар;
6. Задаются описания типов автоцистерн.
Автоцистерны бывают 2-х видов:
 на 15 куб.м. c 3-мя секциями по 5 куб.м.;
 на 30 куб.м. с 4-мя секции: одна 9 куб.м, три по 7 куб.м.
Одна секция для дизеля, остальные для бензина.
Секции для бензина и дизеля – не взаимозаменяемые.
Для цистерны объемом 30 куб.м. секция на 9 куб. м. предназначена для бензина.
7. Задается средний интервал между отпусками топлива из резервуара и среднее количество топлива отпускаемого топлива. Эти числа должны быть заданы таким образом, чтобы средний расход в день из одного резервуара составлял бы 20% от его объема.

Для целей тестирования предполагается, что количество топлива, отпускаемого одному клиенту равномерно распределено в интервале 10л.–50л., что дает в среднем 30л.
Для того, что бы обеспечить расход 20% топлива из резервуара в день, должно выполняться следующее среднее количество заправок:
 для резервуара объемом 10 куб. м. (средний дневной расход - 2 куб. м.) в среднем должно выполняться 66 заправок в день;
 для резервуара объемом 25 куб. м. (средний дневной расход 5 куб. м.) в среднем должно выполняться 166 заправок в день;
 для резервуара объемом 50 куб. м. (средний дневной расход - 2 куб. м.) в среднем должно выполняться 333 заправки в день;

Таким образом, средний интервал между заправками должен составлять:

o для резервуара объемом 10 куб. м. – 1309 сек. (22 мин.)
o для резервуара объемом 25 куб. м. – 520 сек. (8 мин. 40 сек.)
o для резервуара объемом 50 куб. м. – 259 сек. (4 мин. 20 сек.)

При условии, что средний объем отпускаемого одному клиенту топлива составляет 30 л. (равномерно распределенная величина в интервале 10 л. – 50 л.), то приведенные выше средние значения между отпусками топлива розничным клиентам обеспечат расход 20% топлива от объема резервуара в день.
Осуществляется привязка типа автоцистерны к резервуару. При генерации тестовых значений используется правило, согласно которому, резервуары объемом 10 куб. м. и 25 куб. м. обслуживаются автоцистернами объемом 15 куб. м., а резервуары объемом 50 куб. м. обслуживаются автоцистернами объемом 30 куб. м.
Топливо раздаточные колонки (ТРК) и отпускные пистолеты.
В системе моделируется наличие топливозаправочных колонок и топливозаправочных пистолетов, через которые осуществляется отпуск топлива для клиентов.
o Для АЗС с объемом резервуаров 10 куб. м. – 2 ТРК
o Для АЗС с объемом резервуаров 25 куб. м. – 4 ТРК
o Для АЗС с объемом резервуаров 50 куб. м. – 8 ТРК
К каждой ТРК подключается количество пистолетов, удвоенное по отношению числа резервуаров на колонке. Каждый пистолет подключен к своему резервуару.
При отпуске топлива клиенту случайным образом выбирается пистолет, соответствующий резервуару, из которого производится отпуск.
Справочники

Справочник ТРК
ID ТРК - PK
ID АЗС – FK на АЗС
Наименование ТРК

Справочник топливозаправочных пистолетов
ID пистолета - PK
ID АЗС – FK на АЗС
ID Резервуара - FK на Резервуар
Наименование пистолета

Смены и бригады.
Для каждой АЗС фиксируется график смен. На данном этапе считаем, что смена одна и фиксируем время начала смены (или окончания, что в данном случае одно и тоже). Расписание смен для АЗС фиксируется как справочник.
К смене привязывается бригада. Каждую АЗС обслуживают несколько бригад (количество бригад, обслуживающих АЗС фиксируется в привязке к АЗС. Бригад, как мин. 2-е. Одна бригада не может работать две смены подряд. Для отслеживания того, какая бригада работала в тот или иной момент времени создается таблица, отражающая моменты начала новой смены и, соответственно, выход на работу новой другой бригады. Данная таблица содержит, как мин., идентификатор АЗС, дату/время начала смены, дату/время завершения смены, идентификатор бригады (число, не превышающее общего числа бригад для АЗС), уникальный, монотонно возрастающий идентификатор текущей смены.
Справочники
Расписание смен
ID - PK
ID АЗС – FK на АЗС
Время начала смены на АЗС
Продолжительность смены на АЗС в часах

Бригады на АЗС
ID - PK
ID АЗС – FK на АЗС
Количество бригад

II Генерация фактических данных по наливам и сливам

Для каждого резервуара создается непрерывная последовательность операций, представляющих сливы топлива из резервуара в ходе розничных продаж и наливы топлива в резервуар в ходе пополнения их из автоцистерн.

Розничный отпуск – уменьшает объем топлива в резервуаре.
Долив топлива из автоцистерны увеличивает объем топлива в резервуаре.

Для каждой операции отражается следующий состав информации:

Тип операции (отпуск топлива клиентам, долив топлива из автоцистерны);
Объем топлива в резервуаре до операции;
Объем топлива по операции;
Объем топлива в резервуаре после операции;
Дата/время операции.
На вход модуля генерации тестовых наборов значений передаются следующие параметры:
• Дата и время начала и завершения периода, для которого генерируются тестовые данные.
• Порог, связанный с точностью измерений, отклонения в рамках которого не приводят к фиксации аномалий.
• % от общего числа сгенерированных наливов, отклонения в которых превышают допустимый порог.

Генерируемые операции слива и налива должны наиболее реалистично воспроизводить операция, происходящие в реальной жизни. Предполагается, что в реальной жизни при работе АЗС удовлетворяются следующие требования:

Все виды топлива должны присутствовать на АЗС постоянно (во всех резервуарах доступный объем топлива должен быть больше минимального значения (10% объема), поскольку на АЗС нет нескольких резервуаров с одним и тем же видом топлива).
Автоцистерны должны приезжать на АЗС как можно реже, желательно, полностью заправленными (естественно, имея возможность слить все привезенное топливо из отсеков в резервуары, без "дробления" содержимого отсека).
Исходя из этих целей, автоцистерна должна приезжать если:

• Есть возможность полностью слить ее содержимое во все резервуары АЗС, даже если объемы остатков в резервуарах не достигли минимальных критических значений.

ИЛИ

• В каком-либо резервуаре количество топлива снизилось до минимального значения и есть риск прекращения обслуживания клиентов данным видом топлива. Цистерна приезжает, даже если нет возможности слить все отсеки (сливается максимально возможное кол-во отсеков в резервуары АЗС, где есть свободное место, без дробления содержимого отсеков).

Генерации данных по операциям предшествует этап инициализации.

Этап инициализации

На этапе инициализации фиксируются входные параметры, управляющие генерацией наборов данных и выполняются необходимые предварительные настройки, используемые в ходе собственно генерации тестовых данных.

В качестве входных параметров фиксируются параметры, описанные выше.

Также, в ходе инициализации выполняются следующие действия:
• случайным образом устанавливаются исходные объемы в резервуарах на дату/время начала периода генерации данных, исходя из объема в резервуаров. Начальное значение в резервуаре выставляется как случайная величина, равномерно распределенная в интервале:
[10% от объема резервуара : полный объем резервуара]

Этап генерации тестовых значений

Операции генерируются по следующим правилами:

Производится имитация отпусков топлива клиентам с соответствующим уменьшением объемов доступного топлива в резервуарах.
Перед каждым отпуском контролируется состояние резервуаров на АЗС. Автоцистерна приезжает, если:
a) есть возможность слить ее целиком
или
б) в каком-то резервуаре количество топлива снизилось до минимального (даже, если нет возможности слить все отсеки цистерны).
Происходит пополнение резервуаров топливом из автоцистерны генерируется операция налива. При этом:
a) либо сливается все топливо из автоцистерны в резервуары, где имеется свободное место
b) либо в первую очередь пополняется резервуар, где топливо заканчивается, и доливаются те резервуары, где есть свободный объем (при этом могут быть задействованы не все отсеки автоцистерны – задача этого сценария в первую очередь пополнить пустеющий резервуар, а параллельно минимизировать пробег не полностью загруженного автомобиля, долив в резервуары те секции, цистерны, которые могут туда поместиться).

Переход к п.1
Генерация данных для операций розничного отпуска топлива

Для выбранного резервуара, заполненность которого превышает объем, требующий осуществление процедуры налива из автоцистерны, генерируется следующие данные для процедуры розничного отпуска нефтепродуктов:

• Тип операции – розничный отпуск.
• Объем топлива в резервуаре до операции – текущий объем топлива из характеристик резервуара.
• Объем топлива по операции – случайное значение, с с равномерным распределением из интервала [10л. : 50л.].
• Объем топлива в резервуаре после операции – объем топлива в резервуаре до операции, плюс объем топлива по розничной операции.
• Дата/время операции – время предыдущей операции в этом резервуаре, плюс случайный интервал времени, равномерно распределенный в интервале от 0 до 2-х средних интервалов между заправками для данного типа резервуара.

По результатам генерации данных для операции розничной продажи обновляется текущий объем топлива в резервуаре.

Дата/время операции сравнивается с датой/временем завершения генерации тестового набора. Если дата/время операции равна или превышает дату/время завершения генерации тестового набора, то генерация тестовых значений для данного резервуара прекращается. Общая генерация тестовых данных завершается, когда завершена генерация наборов данных для всех резервуаров.

Генерация данных для операции налива топлива резервуар из автоцистерны

• Тип операции – налив из автоцистерны
• Объем топлива в резервуаре до операции – объем топлива из характеристик резервуара.
• Объем топлива по операции – объем топлива, из одного или более отсеков автоцистерны, суммарный объем которых вместе с остатком в резервуаре не превышает объема резервуара. Для ДТ осуществляется налив объем топлива, содержащийся в одном отсеке автоцистерны минимального объема. Для бензина осуществляется налив из нескольких отсеков автоцистерны вплоть до заполнения резервуара (исключая один отсек автоцистерны, предназначенный для ДТ) Дата/время операции – дата/время последней операции по данному резервуару, плюс среднее время между операциями по отпуску топлива для клиентов. В ходе операции отсек автоцистерны сливается в резервуар целиком или не сливается вообще.

Привязка событий к смене
Каждое событие (налив в резервуар из отсека автоцистерны или отпуск топлива через пистолет) должен фиксироваться в привязке к смене.
В общем случае, при проведении операции происходит обращение к таблицам, где фиксируется регламентное время начала новой смены и к таблице, где фиксируется фактическое время начала/завершения очередной смены. Для текущей смены время завершения будет незаполненным.
Если время события не превышает время закрытия активной текущей смены, то ей назначается активная текущая смена.
Если время события превышает время закрытия активной текущей смены, то текущая смена закрывается, открывается новая. Операция маркируется идентификатором новой смены.
Если речь идет об операции слива топлива в автоцистерну, то она состоит из 3-х событий (замер в резервуаре до слива, фиксация слитого по ТТН, замер в резервуаре после слива). Все эти события должны происходить в одну смену. Смена для первого события в цепочке выбирается указанным выше образом. Все остальные события цепочки привязываются к смене первого события.
В ходе слива в резервуар смена не может быть переключена. Для того, что бы исключить возможность переключения смен в ходе операции слива предлагается организовать специальную таблицу, в которой фиксировать факт того, что в данный момент выполняется слив. В этой таблице существует специальное целочисленное поле, куда изначально записано значение 0. При фиксации события замера в резервуаре до слива из автоцистерны это поле увеличивается на 1. При фиксации события замера в резервуаре после слива это поле уменьшается на 1. Таким образом – нулевое значение в этом поле говорит о том, что переключение смены возможно. Ненулевое значение говорит о том что переключение смены невозможно. Если, примерно одновременно, происходят два события налива, то они последовательно увеличат указанный выше счетчик до 2-х, а по завершении сбросят в 0. Смена не завершится, пока не закончатся обе операции налива. Если одновременно идут более двух операций налива, то принцип работы такой же. Смена переключится (при необходимости) после завершения всех операций налива.

Замечание:
Время налива выбирается как "максимальное текущее время" по всем резервуарам

Дополнение:
В рассматриваемом сценарии сигналом к переключению смены является очередное событие налива или слива. Это событие не совершается точно в момент времени, когда смена должна переключится по регламенту (событие совершается несколько позднее).
Для более точного выставления времени переключения смены в соответствии с регламентом производятся следующие действия:
• Выбирается последняя операция на данной АЗС, предшествующая той, которая явилась триггером переключения смены и фиксируется ее время (время предпоследней операции).
• Фиксируется время, когда должно быть осуществлено переключение смены по расписанию (плановое время).
• Если время предпоследней операции предшествует плановому времени переключения смены, то в качестве времени переключения используется плановое время переключения.
• Если время предпоследней операции превосходит время планового переключения, то в качестве фактического времени переключения смены используется время предпоследней операции (возможно, шел налив в резервуар из цистерны).

Переход на новую смену без учета запаздываний, связанных с доливами

Перед доливом из автоцистерны в резервуар

Замер состояния резервуара перед доливом

Прием топлива по ТТН

Замер состояния резервуара после залива

Операция продажи после долива и переключение смены

Дополнительные таблицы для поддержки отпуска нефтепродуктов

Факты по сменам
ID смены – PK
ID АЗС – FK на АЗС
Время начала смены
Время завершения смены

Текущие активные наливы для АЗС
ID – PK
ID АЗС – FK на АЗС
ID смены - FK на факты смен
Кол-во - Колво текущих активых сливов

III Расхождения
Данные о количестве топлива в автоцистерне, по ТТН и полученные путем измерения объема топлива в резервуаре до и после слива, получаемые из источников практически всегда будут расходится между собой из-за наличия отклонений. Если эти отклонения не выходят за заданный порог, то аномалия не возбуждается.
В тестовых наборах данных такие отклонения в объеме топлива в автоцистерне, полученные из ТТН и путем измерений, имитируются способом, описанным ниже.

Для имитации отклонений в рамках допустимого порога, генерируется случайная величина с равномерным распределением в интервале:
[ - допустимый порог : + допустимый порог ]
Эта величина случайным образом добавляется либо к значению по ТТН, либо к замеру количества в резервуаре после слива, несколько изменяя, таким образом, значения этих данных. Значения с имитацией отклонений фиксируются в отдельных полях генерируемого набора данных. Т. е., в выходной структуре данных присутствую три поля ("в резервуаре до", "по накладной", "в резервуаре после") для сгенерированных данных без отклонений, и три аналогичных поля для данных с отклонениями ("в резервуаре до с отклонением", "по ТТН с отклонением", "в резервуаре после с отклонением"). Таким образом "искажаются" все данные о наливах.

IV Аномалии
Данные о количестве топлива в автоцистерне, полученное из ТТН и путем измерения объема топлива в резервуаре до и после слива будет в ряде случаев расходится на величину превышающую порог. Такие отклонения должны вызывать возбуждение аномалий. Тестовые данные с отклонениями, превышающими порог, так же должны быть включены в генерируемые наборы данных. Для генерации таких данных используется следующий подход:

Количество наливов с такими отклонениями задается в виде % от общего числа наливов и передается на вход генератору как параметр (о чем указывалось выше, при описании входных параметров генератора). Для имитации таких отклонений случайным образом отбирается заданный % от общего количества событий налива. Для каждого такого события генерируется случайная величина отклонения, вызывающая аномалию, с равномерным распределением вероятности, в диапазоне:
[допустимый порог : допустимый порог *2]
Половина таких величин, отобранных случайным образом, умножается на (-1), чем имитируется отклонение в ту или иную сторону. Эта величина случайным образом добавляется либо к значению по ТТН, либо к замеру количества в резервуаре после слива для неискаженных данных, изменяя, таким образом, значения этих данных. Искаженные данные фиксируются в отдельных полях ("в резервуаре до с отклонением", "по ТТН с отклонением", "в резервуаре после с отклонением"), аналогичных тем, которые используются для имитации погрешностей измерений, перезаписывая их.
В качестве выходных данных используются поля с искаженными значениями.
